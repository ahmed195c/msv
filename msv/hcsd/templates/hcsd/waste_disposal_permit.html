{% extends "hcsd/base.html" %}
{% block title %}تصريح التخلص من النفايات{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

  :root {
    --ink: #1b1b1b;
    --muted: #5e5e5e;
    --line: #2a2a2a;
    --paper: #fbf9f5;
    --accent: #1f5a4b;
    --accent-soft: #e2ede9;
  }

  .permit-page {
    background:
      radial-gradient(circle at 10% 10%, rgba(31, 90, 75, 0.08), transparent 45%),
      radial-gradient(circle at 90% 20%, rgba(176, 132, 46, 0.08), transparent 40%),
      linear-gradient(180deg, #f2efe7, #f8f6f1);
    padding: 32px 16px;
  }

  .permit-card {
    font-family: "Cairo", "Noto Kufi Arabic", "Tahoma", sans-serif;
    max-width: 980px;
    margin: 0 auto;
    background: var(--paper);
    border: 2px solid var(--line);
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
    padding: 26px 24px 30px;
    color: var(--ink);
  }

  .permit-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
    border-bottom: 2px solid var(--line);
    padding-bottom: 16px;
  }

  .municipality {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-box {
    width: 76px;
    height: 76px;
    border: 2px solid var(--line);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: var(--muted);
    background: #fff;
  }

  .municipality-text .title {
    font-weight: 700;
    font-size: 18px;
  }

  .municipality-text .sub {
    font-size: 13px;
    color: var(--muted);
  }

  .permit-number {
    display: grid;
    gap: 6px;
    min-width: 220px;
  }

  .permit-number label {
    font-size: 13px;
    color: var(--muted);
  }

  .permit-title {
    margin: 18px 0 12px;
    text-align: center;
    font-weight: 700;
    font-size: 20px;
    padding: 10px 12px;
    border: 2px solid var(--line);
    background: var(--accent-soft);
    letter-spacing: 0.4px;
  }

  .permit-section {
    margin-top: 18px;
    border: 1px solid var(--line);
    padding: 14px;
  }

  .section-title {
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 12px;
    display: inline-block;
    padding: 4px 10px;
    background: #fff;
    border: 1px solid var(--line);
  }

  .permit-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px 16px;
  }

  .field {
    display: grid;
    gap: 6px;
  }

  .check {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    margin-bottom: 8px;
  }

  .field label {
    font-size: 13px;
    color: var(--muted);
  }

  .field input,
  .field textarea,
  .field select {
    border: 1px solid var(--line);
    padding: 8px 10px;
    font-size: 14px;
    background: #fff;
  }

  .field input[type="date"],
  .field input[type="number"] {
    direction: ltr;
    text-align: right;
  }

  .field textarea {
    min-height: 90px;
    resize: vertical;
  }

  .permit-actions {
    margin-top: 18px;
    display: flex;
    justify-content: center;
    gap: 12px;
  }

  .permit-actions button {
    border: none;
    padding: 10px 20px;
    font-size: 15px;
    cursor: pointer;
    background: var(--accent);
    color: #fff;
  }

  .permit-actions .secondary {
    background: #494949;
  }

  .alert {
    border: 1px solid #a33;
    background: #fff4f4;
    color: #8a1f1f;
    padding: 10px 12px;
    margin: 14px 0 0;
    font-size: 14px;
  }

  .alert-success {
    border-color: #2f7a63;
    background: #edf7f3;
    color: #1f5a4b;
  }

  .hint {
    font-size: 12px;
    color: var(--muted);
  }

  @media (max-width: 680px) {
    .permit-card {
      padding: 20px 16px;
    }

    .permit-title {
      font-size: 18px;
    }
  }
</style>

<section class="permit-page" lang="ar" dir="rtl">
  <form class="permit-card" method="post" enctype="multipart/form-data" autocomplete="off">
    {% csrf_token %}
    <header class="permit-header">
      <div class="municipality">
        <div class="logo-box">شعار البلدية</div>
        <div class="municipality-text">
          <div class="title">بلدية مدينة الشارقة</div>
          <div class="sub">إدارة الرقابة والسلامة الصحية</div>
          <div class="sub">قسم رقابة وتنظيم النفايات</div>
        </div>
      </div>
      <div class="permit-number">
        <label for="permit_no">رقم التصريح</label>
        <input type="text" id="permit_no" value="يُولد تلقائياً" disabled>
      </div>
    </header>

    <div class="permit-title">تصريح التخلص من النفايات</div>

    {% if form_errors %}
      <div class="alert">
        <strong>يرجى تصحيح التالي:</strong>
        <ul style="margin: 8px 0 0 18px;">
          {% for error in form_errors %}
            <li>
              {% if error == "company_select_invalid" %}
                يرجى اختيار شركة مسجلة صحيحة.
              {% elif error == "company_name_required" %}
                يرجى إدخال الاسم التجاري.
              {% elif error == "trade_license_no_required" %}
                يرجى إدخال رقم الرخصة التجارية.
              {% elif error == "trade_license_exp_required" %}
                يرجى إدخال تاريخ انتهاء الرخصة.
              {% elif error == "trade_license_exp_invalid" %}
                تاريخ انتهاء الرخصة غير صالح.
              {% elif error == "company_address_required" %}
                يرجى إدخال عنوان الشركة.
              {% elif error == "business_activity_required" %}
                يرجى اختيار أنشطة الرخصة.
              {% elif error == "issue_date_required" %}
                يرجى إدخال تاريخ الإصدار.
              {% elif error == "issue_date_invalid" %}
                تاريخ الإصدار غير صالح.
              {% elif error == "expiry_date_required" %}
                يرجى إدخال تاريخ الانتهاء.
              {% elif error == "expiry_date_invalid" %}
                تاريخ الانتهاء غير صالح.
              {% elif error == "receipt_date_invalid" %}
                تاريخ الإيصال غير صالح.
              {% elif error == "waste_classification_required" %}
                يرجى إدخال تصنيف النفايات.
              {% elif error == "waste_quantity_required" %}
                يرجى إدخال كمية النفايات الشهرية.
              {% elif error == "waste_quantity_invalid" %}
                كمية النفايات الشهرية غير صالحة.
              {% elif error == "waste_types_required" %}
                يرجى إدخال أنواع النفايات.
              {% elif error == "material_state_required" %}
                يرجى إدخال حالة المادة.
              {% elif error == "documents_required" %}
                يرجى إرفاق مستند واحد على الأقل.
              {% elif error == "documents_invalid" %}
                الملفات المسموحة هي PDF أو صور فقط: {{ invalid_docs|join:", " }}
              {% else %}
                {{ error }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if success_message %}
      <div class="alert alert-success">
        {% if success_message == "submitted" %}
          تم استلام الطلب وإرفاق المستندات بنجاح.
        {% else %}
          {{ success_message }}
        {% endif %}
      </div>
    {% endif %}

    <section class="permit-section">
      <div class="section-title">بيانات التصريح</div>
      <div class="permit-grid">
        <div class="field">
          <label for="issue_date">تاريخ الإصدار</label>
          <input type="date" id="issue_date" name="issue_date" required>
        </div>
        <div class="field">
          <label for="expiry_date">تاريخ الانتهاء</label>
          <input type="date" id="expiry_date" name="expiry_date" required>
        </div>
        <div class="field">
          <label for="receipt_no">رقم الإيصال</label>
          <input type="text" id="receipt_no" name="receipt_no">
        </div>
        <div class="field">
          <label for="receipt_date">تاريخ الإيصال</label>
          <input type="date" id="receipt_date" name="receipt_date">
        </div>
      </div>
    </section>

    <section class="permit-section">
      <div class="section-title">بيانات الشركة</div>
      <div class="permit-grid">
        <div class="field">
          <label for="company_search">بحث بالاسم أو رقم الرخصة</label>
          <input type="text" id="company_search" data-company-search placeholder="ابحث بالاسم أو رقم الرخصة">
        </div>
        <div class="field">
          <label for="company_id">اختيار الشركة المسجلة</label>
          <select id="company_id" name="company_id" data-company-select>
            <option value="">-- اختيار --</option>
            {% for company in companies %}
              <option
                value="{{ company.id }}"
                data-name="{{ company.name }}"
                data-number="{{ company.number }}"
                data-license-exp="{{ company.trade_license_exp|date:'Y-m-d' }}"
                data-activity="{{ company.business_activity }}"
                data-address="{{ company.address }}"
                data-landline="{{ company.landline }}"
                data-owner-phone="{{ company.owner_phone }}"
                data-email="{{ company.email }}"
                data-engineer-name="{{ company.enginer.name }}"
                data-engineer-email="{{ company.enginer.email }}"
                data-engineer-phone="{{ company.enginer.phone }}"
                data-search="{{ company.name }} {{ company.number }}"
                {% if company.id == selected_company_id %}selected{% endif %}
              >
                {{ company.name }} - {{ company.number }}
              </option>
            {% endfor %}
          </select>
          <div class="hint">إذا لم تكن الشركة موجودة، أدخل البيانات يدويًا أدناه.</div>
        </div>
        <div class="field">
          <label for="company_name">الاسم التجاري</label>
          <input type="text" id="company_name" name="company_name">
        </div>
        <div class="field">
          <label for="trade_license_no">رقم الرخصة التجارية</label>
          <input type="text" id="trade_license_no" name="trade_license_no">
        </div>
        <div class="field">
          <label for="trade_license_exp">تاريخ انتهاء الرخصة التجارية</label>
          <input type="date" id="trade_license_exp" name="trade_license_exp">
        </div>
        <div class="field">
          <label>أنشطة الرخصة</label>
          <label class="check">
            <input type="checkbox" name="business_activity" value="pest_control"
              {% if selected_business_activities and "pest_control" in selected_business_activities %}checked{% endif %}>
            نشاط مكافحة
          </label>
          <label class="check">
            <input type="checkbox" name="business_activity" value="buy_sell"
              {% if selected_business_activities and "buy_sell" in selected_business_activities %}checked{% endif %}>
            نشاط بيع وشراء
          </label>
          <label class="check">
            <input type="checkbox" name="business_activity" value="cleaning"
              {% if selected_business_activities and "cleaning" in selected_business_activities %}checked{% endif %}>
            نشاط نظافة
          </label>
        </div>
        <div class="field">
          <label for="company_address">عنوان الشركة</label>
          <input type="text" id="company_address" name="company_address">
        </div>
        <div class="field">
          <label for="landline">رقم الهاتف الأرضي</label>
          <input type="tel" id="landline" name="landline">
        </div>
        <div class="field">
          <label for="owner_phone">رقم هاتف المالك</label>
          <input type="tel" id="owner_phone" name="owner_phone">
        </div>
        <div class="field">
          <label for="company_email">البريد الإلكتروني</label>
          <input type="email" id="company_email" name="company_email">
        </div>
      </div>
    </section>

    <section class="permit-section">
      <div class="section-title">بيانات النفايات</div>
      <div class="permit-grid">
        <div class="field">
          <label for="waste_classification">تصنيف النفايات</label>
          <input type="text" id="waste_classification" name="waste_classification" required>
        </div>
        <div class="field">
          <label for="waste_quantity_monthly">كمية النفايات (الشهرية)</label>
          <input type="number" step="0.01" id="waste_quantity_monthly" name="waste_quantity_monthly" required>
        </div>
        <div class="field">
          <label for="waste_types">أنواع النفايات</label>
          <textarea id="waste_types" name="waste_types" required></textarea>
        </div>
        <div class="field">
          <label for="material_state">حالة المادة</label>
          <input type="text" id="material_state" name="material_state" required>
        </div>
      </div>
    </section>

    <section class="permit-section">
      <div class="section-title">بيانات المشروع</div>
      <div class="permit-grid">
        <div class="field">
          <label for="project_number">رقم المشروع</label>
          <input type="text" id="project_number" name="project_number">
        </div>
        <div class="field">
          <label for="project_type">نوع المشروع</label>
          <input type="text" id="project_type" name="project_type">
        </div>
        <div class="field">
          <label for="contractors">للمقاولات</label>
          <input type="text" id="contractors" name="contractors">
        </div>
        <div class="field">
          <label for="employee_number">الموظف المختص</label>
          <input type="text" id="employee_number" name="employee_number">
        </div>
      </div>
    </section>

    <section class="permit-section">
      <div class="section-title">مستندات الطلب</div>
      <div class="permit-grid">
        <div class="field">
          <label for="documents">إرفاق المستندات (PDF أو صور)</label>
          <input type="file" id="documents" name="documents" accept=".pdf,image/*" multiple required>
          <div class="hint">يمكنك اختيار أكثر من ملف في نفس الوقت.</div>
        </div>
      </div>
    </section>

    <div class="permit-actions">
      <button type="submit">حفظ الطلب</button>
      <button type="reset" class="secondary">تفريغ</button>
    </div>
  </form>
</section>
<script>
  (function () {
    const searchInput = document.querySelector('[data-company-search]');
    const select = document.querySelector('[data-company-select]');
    if (!select) {
      return;
    }

    const options = Array.from(select.options).filter((option) => option.value);
    const autoFilled = {};

    options.forEach((option) => {
      const rawSearch = option.dataset.search || option.textContent || '';
      option.dataset.search = rawSearch.toLowerCase();
    });

    const setField = (id, value) => {
      const field = document.getElementById(id);
      if (!field) {
        return;
      }
      const normalized = value || '';
      field.value = normalized;
      autoFilled[id] = normalized;
    };

    const clearIfAutoFilled = (id) => {
      const field = document.getElementById(id);
      if (!field) {
        return;
      }
      if (autoFilled[id] !== undefined && field.value === autoFilled[id]) {
        field.value = '';
      }
    };

    const fieldMap = {
      company_name: 'name',
      trade_license_no: 'number',
      trade_license_exp: 'licenseExp',
      company_address: 'address',
      landline: 'landline',
      owner_phone: 'ownerPhone',
      company_email: 'email',
    };

    const activityInputs = Array.from(
      document.querySelectorAll('input[name="business_activity"]')
    );

    const normalizeActivities = (value) => {
      if (!value) {
        return [];
      }
      return value
        .split(',')
        .map((item) => item.trim())
        .filter(Boolean);
    };

    const setActivities = (value) => {
      if (!activityInputs.length) {
        return;
      }
      const items = normalizeActivities(value);
      const selected = new Set(items);
      activityInputs.forEach((input) => {
        input.checked = selected.has(input.value);
      });
      autoFilled.business_activity = items.join(',');
    };

    const clearActivitiesIfAutoFilled = () => {
      if (!activityInputs.length) {
        return;
      }
      if (autoFilled.business_activity === undefined) {
        return;
      }
      const current = activityInputs
        .filter((input) => input.checked)
        .map((input) => input.value)
        .join(',');
      if (current === autoFilled.business_activity) {
        activityInputs.forEach((input) => {
          input.checked = false;
        });
      }
    };

    const fillFromOption = (option) => {
      if (!option || !option.value) {
        Object.keys(fieldMap).forEach(clearIfAutoFilled);
        clearActivitiesIfAutoFilled();
        return;
      }
      Object.entries(fieldMap).forEach(([fieldId, dataKey]) => {
        setField(fieldId, option.dataset[dataKey]);
      });
      setActivities(option.dataset.activity);
    };

    if (searchInput) {
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim().toLowerCase();
        options.forEach((option) => {
          option.hidden = query && !option.dataset.search.includes(query);
        });
      });
    }

    select.addEventListener('change', () => {
      fillFromOption(select.options[select.selectedIndex]);
    });

    if (select.value) {
      fillFromOption(select.options[select.selectedIndex]);
    }
  })();
</script>
{% endblock %}

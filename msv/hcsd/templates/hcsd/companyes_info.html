{% extends "hcsd/base.html" %}
{% block title %}الشركات{% endblock %}
{% block content %}
<style>
  .company-page {
    padding: 20px;
  }

  .company-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
  }

  .company-actions a {
    background: #1f5a4b;
    color: #fff;
    padding: 8px 14px;
    text-decoration: none;
    border-radius: 4px;
  }

  .filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    column-gap: 24px;
    row-gap: 20px;
    margin-bottom: 16px;
    align-items: end;
    padding-bottom: 4px;
  }

  .filters label {
    display: block;
    font-size: 12px;
    color: #555;
    margin-bottom: 4px;
  }

  .filters input,
  .filters select {
    margin: 10px;
    border: 1px solid #ccc;
    padding: 8px 10px;
    font-size: 14px;
    background: #fff;
    width: 100%;
  }

  .filters button,
  .filters a {
    border: none;
    padding: 9px 14px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 4px;
    text-decoration: none;
    text-align: center;
  }

  .filters button {
    background: #1f5a4b;
    color: #fff;
  }

  .filters a {
    background: #494949;
    color: #fff;
  }

  .hint {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }

  .company-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
  }

  .company-table th,
  .company-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: right;
  }

  .company-table thead {
    background: #f4f4f4;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .tag {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 999px;
    background: #e2ede9;
    color: #1f5a4b;
    font-size: 12px;
    border: 1px solid #c7d8d2;
  }

  .details-link {
    background: #1f5a4b;
    color: #fff;
    padding: 6px 10px;
    text-decoration: none;
    border-radius: 4px;
    display: inline-block;
  }

</style>

<section class="company-page" lang="ar" dir="rtl">
  <div class="company-header">
    <div>
      <h1 style="margin: 0;">قائمة الشركات</h1>
      <div class="hint">نوع الشركة حسب آخر تصريح صادر أو بيانات التسجيل.</div>
    </div>
    <div class="company-actions">
      {% if can_add_company %}
        <a href="{% url 'add_company' %}">إضافة شركة جديدة</a>
      {% else %}
        <em>إضافة الشركات متاحة فقط لمسؤولي الإدخال أو الإدارة.</em>
      {% endif %}
    </div>
  </div>

  <form class="filters" method="get">
    <div>
      <label for="q">بحث</label>
      <input type="text" id="q" name="q" value="{{ query }}" placeholder="ابحث بالاسم أو رقم الرخصة">
    </div>
    <div>
      <label for="activity">نوع الشركة</label>
      <select id="activity" name="activity">
        <option value="all" {% if activity_filter == "all" %}selected{% endif %}>الكل</option>
        <option value="public_health_pest_control" {% if activity_filter == "public_health_pest_control" %}selected{% endif %}>مكافحة آفات الصحة العامة</option>
        <option value="termite_control" {% if activity_filter == "termite_control" %}selected{% endif %}>مكافحة النمل الأبيض</option>
        <option value="grain_pests" {% if activity_filter == "grain_pests" %}selected{% endif %}>مكافحة آفات الحبوب</option>
      </select>
    </div>
    <div>
      <label for="sort">الترتيب</label>
      <select id="sort" name="sort">
        <option value="name_asc" {% if sort == "name_asc" %}selected{% endif %}>الاسم (أ - ي)</option>
        <option value="name_desc" {% if sort == "name_desc" %}selected{% endif %}>الاسم (ي - أ)</option>
        <option value="number_asc" {% if sort == "number_asc" %}selected{% endif %}>رقم الرخصة (تصاعدي)</option>
        <option value="number_desc" {% if sort == "number_desc" %}selected{% endif %}>رقم الرخصة (تنازلي)</option>
        <option value="last_issued_desc" {% if sort == "last_issued_desc" %}selected{% endif %}>آخر تصريح (الأحدث)</option>
        <option value="last_issued_asc" {% if sort == "last_issued_asc" %}selected{% endif %}>آخر تصريح (الأقدم)</option>
      </select>
    </div>
    <div>
      <button type="submit">تطبيق</button>
    </div>
    <div>
      <a href="{% url 'company_list' %}">إعادة ضبط</a>
    </div>
  </form>

  {% if company_rows %}
    <table class="company-table">
      <thead>
        <tr>
          <th>اسم الشركة</th>
          <th>رقم الرخصة</th>
          <th>نوع الشركة</th>
          <th>نوع المكافحة</th>
          <th>المهندس</th>
          <th>آخر تصريح</th>
          <th>التفاصيل</th>
        </tr>
      </thead>
      <tbody>
        {% for row in company_rows %}
          <tr>
            <td>{{ row.company.name }}</td>
            <td>{{ row.company.number }}</td>
            <td>
              <div class="tags">
                {% for label in row.activity_labels %}
                  <span class="tag">{{ label }}</span>
                {% endfor %}
              </div>
            </td>
            <td>
              {% if row.company.pest_control_type == "public_health_pest_control" %}
                مكافحة آفات الصحة العامة
              {% elif row.company.pest_control_type == "termite_control" %}
                مكافحة النمل الأبيض
              {% elif row.company.pest_control_type == "grain_pests" %}
                مكافحة آفات الحبوب
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if row.company.enginer %}
                {{ row.company.enginer.name }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ row.last_issued|default:"-" }}</td>
            <td>
              <a class="details-link" href="{% url 'company_detail' row.company.id %}">عرض</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>لا توجد شركات مطابقة. <a href="{% url 'add_company' %}">إضافة شركة</a></p>
  {% endif %}
</section>
{% endblock %}

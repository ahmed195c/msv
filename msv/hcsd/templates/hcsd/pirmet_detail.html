{% extends "hcsd/base.html" %}
{% block title %}تفاصيل طلب التصريح{% endblock %}
{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

  :root {
    --ink: #1b1b1b;
    --muted: #5e5e5e;
    --line: #2a2a2a;
    --paper: #fbf9f5;
    --accent: #1f5a4b;
    --accent-soft: #e2ede9;
  }

  .permit-page {
    background:
      radial-gradient(circle at 10% 10%, rgba(31, 90, 75, 0.08), transparent 45%),
      radial-gradient(circle at 90% 20%, rgba(176, 132, 46, 0.08), transparent 40%),
      linear-gradient(180deg, #f2efe7, #f8f6f1);
    padding: 32px 16px;
  }

  .permit-card {
    font-family: "Cairo", "Noto Kufi Arabic", "Tahoma", sans-serif;
    max-width: 980px;
    margin: 0 auto;
    background: var(--paper);
    border: 2px solid var(--line);
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
    padding: 26px 24px 30px;
    color: var(--ink);
  }

  .back-link {
    display: inline-block;
    margin-bottom: 14px;
    color: #fff;
    background: #494949;
    padding: 8px 14px;
    text-decoration: none;
    border-radius: 4px;
  }

  .action-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }

  .print-button {
    display: inline-block;
    border: none;
    padding: 8px 16px;
    background: var(--accent);
    color: #fff;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    text-decoration: none;
  }

  .print-button:hover {
    background: #17473b;
  }

  .permit-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
    border-bottom: 2px solid var(--line);
    padding-bottom: 16px;
  }

  .municipality {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-box {
    width: 76px;
    height: 76px;
    border: 2px solid var(--line);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: var(--muted);
    background: #fff;
  }

  .municipality-text .title {
    font-weight: 700;
    font-size: 18px;
  }

  .municipality-text .sub {
    font-size: 13px;
    color: var(--muted);
  }

  .meta-grid {
    display: grid;
    gap: 8px;
    min-width: 220px;
  }

  .meta-item {
    display: grid;
    gap: 4px;
  }

  .meta-item .label {
    font-size: 12px;
    color: var(--muted);
  }

  .meta-item .value {
    font-size: 14px;
    font-weight: 600;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    background: var(--accent-soft);
    color: var(--accent);
    border: 1px solid var(--accent);
    border-radius: 16px;
    font-size: 13px;
  }

  .permit-title {
    margin: 18px 0 12px;
    text-align: center;
    font-weight: 700;
    font-size: 20px;
    padding: 10px 12px;
    border: 2px solid var(--line);
    background: var(--accent-soft);
    letter-spacing: 0.4px;
  }

  .permit-section {
    margin-top: 18px;
    border: 1px solid var(--line);
    padding: 14px;
    background: #fff;
  }

  .section-title {
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 12px;
    display: inline-block;
    padding: 4px 10px;
    background: var(--paper);
    border: 1px solid var(--line);
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px 16px;
  }

  .detail-item {
    border: 1px solid var(--line);
    padding: 8px 10px;
    background: #fff;
    display: grid;
    gap: 6px;
  }

  .detail-item .label {
    font-size: 12px;
    color: var(--muted);
  }

  .detail-item .value {
    font-size: 14px;
    font-weight: 600;
  }

  .activity-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 6px;
  }

  .activity-list li {
    border: 1px solid var(--line);
    padding: 6px 10px;
    background: #fff;
  }

  .documents a {
    color: var(--accent);
    text-decoration: none;
  }

  .tracking-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
  }

  .tracking-panel {
    border: 1px solid var(--line);
    padding: 12px;
    background: #fff;
  }

  .tracking-title {
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 14px;
  }

  .tracking-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 10px;
  }

  .tracking-item {
    border: 1px dashed var(--line);
    padding: 8px 10px;
    background: #fbfbfb;
    display: grid;
    gap: 4px;
  }

  .tracking-meta {
    font-size: 12px;
    color: var(--muted);
  }

  .review-form {
    display: grid;
    gap: 8px;
  }

  .review-form input,
  .review-form select,
  .review-form textarea {
    border: 1px solid var(--line);
    padding: 6px 8px;
    font-size: 13px;
    background: #fff;
  }

  .review-form button {
    border: none;
    padding: 8px 12px;
    background: var(--accent);
    color: #fff;
    border-radius: 4px;
    cursor: pointer;
  }

  .review-form .danger {
    background: #8a1f1f;
  }

  .alert {
    border: 1px solid #a33;
    background: #fff4f4;
    color: #8a1f1f;
    padding: 10px 12px;
    margin: 14px 0 0;
    font-size: 14px;
  }

  .hint {
    font-size: 12px;
    color: var(--muted);
  }

  @media (max-width: 680px) {
    .permit-card {
      padding: 20px 16px;
    }

    .permit-title {
      font-size: 18px;
    }
  }

  @media print {
    .no-print {
      display: none !important;
    }
  }
</style>

<section class="permit-page" lang="ar" dir="rtl">
  <div class="permit-card">
    <div class="action-bar no-print">
      <a class="back-link" href="{% url 'clearance_list' %}">العودة إلى قائمة الطلبات</a>
      {% if pirmet.status == "issued" or pirmet.status == "payment_completed" %}
        <a class="print-button" href="{% url 'pirmet_print' pirmet.id %}" target="_blank" rel="noopener">طباعة التصريح</a>
      {% endif %}
    </div>

    <header class="permit-header">
      <div class="municipality">
        <div class="logo-box">شعار البلدية</div>
        <div class="municipality-text">
          <div class="title">بلدية مدينة الشارقة</div>
          <div class="sub">إدارة الرقابة والسلامة الصحية</div>
          <div class="sub">قسم رقابة وتنظيم النفايات</div>
        </div>
      </div>
      <div class="meta-grid">
        <div class="meta-item">
          <span class="label">رقم التصريح</span>
          <span class="value">{{ pirmet.permit_no|default:"-" }}</span>
        </div>
        <div class="meta-item">
          <span class="label">نوع التصريح</span>
          <span class="value">
            {% if pirmet.permit_type == "pest_control" %}
              تصريح مزاولة نشاط مكافحة آفات الصحة العامة
            {% elif pirmet.permit_type == "pesticide_transport" %}
              تصريح نقل مبيدات آفات الصحة العامة
            {% elif pirmet.permit_type == "waste_disposal" %}
              تصريح التخلص من النفايات
            {% else %}
              -
            {% endif %}
          </span>
        </div>
        <div class="meta-item">
          <span class="label">الحالة الحالية</span>
          <span class="status-badge">
            {% if pirmet.status == "order_received" %}
              تم استلام الطلب
            {% elif pirmet.status == "inspection_payment_pending" %}
              تم إرسال رابط دفع التفتيش وبانتظار الدفع
            {% elif pirmet.status == "review_pending" %}
              بانتظار مراجعة المفتش
            {% elif pirmet.status == "needs_completion" or pirmet.status == "rejected" %}
              نواقص بحاجة للاستكمال
            {% elif pirmet.status == "approved" %}
              تم الاعتماد من المفتش{% if inspector_review and inspector_review.inspector %} {{ inspector_review.inspector.name }}{% endif %}
            {% elif pirmet.status == "payment_pending" %}
              بانتظار دفع التصريح
            {% elif pirmet.status == "payment_completed" %}
              تم استلام الدفع
            {% elif pirmet.status == "issued" %}
              تم إصدار التصريح
            {% elif pirmet.status == "inspection_pending" %}
              تفتيش قيد الانتظار
            {% elif pirmet.status == "inspection_completed" %}
              تم التفتيش
            {% elif pirmet.status == "disposal_approved" %}
              تمت الموافقة على الإتلاف
            {% elif pirmet.status == "disposal_rejected" %}
              تم رفض الإتلاف
            {% else %}
              {{ pirmet.get_status_display }}
            {% endif %}
          </span>
        </div>
      </div>
    </header>

    <div class="permit-title">
      {% if pirmet.permit_type == "pest_control" %}
        تفاصيل طلب تصريح مزاولة نشاط مكافحة آفات الصحة العامة
      {% elif pirmet.permit_type == "pesticide_transport" %}
        تفاصيل طلب تصريح نقل مبيدات آفات الصحة العامة
      {% elif pirmet.permit_type == "waste_disposal" %}
        تفاصيل طلب تصريح التخلص من النفايات
      {% else %}
        تفاصيل طلب تصريح
      {% endif %}
    </div>

    <section class="permit-section">
      <div class="section-title">بيانات التصريح</div>
      <div class="detail-grid">
        <div class="detail-item">
          <span class="label">تاريخ إصدار التصريح</span>
          <span class="value">{{ pirmet.issue_date|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">تاريخ انتهاء التصريح</span>
          <span class="value">{{ pirmet.dateOfExpiry|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">تاريخ إنشاء الطلب</span>
          <span class="value">{{ pirmet.dateOfCreation|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">رقم مرجع دفع التصريح</span>
          <span class="value">{{ pirmet.PaymentNumber|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">تاريخ دفع التصريح</span>
          <span class="value">{{ pirmet.payment_date|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">رابط دفع التصريح</span>
          <span class="value">
            {% if pirmet.payment_link %}
              <a href="{{ pirmet.payment_link }}" target="_blank" rel="noopener">فتح الرابط</a>
            {% else %}
              -
            {% endif %}
          </span>
        </div>
        <div class="detail-item">
          <span class="label">رقم مرجع دفع التفتيش</span>
          <span class="value">{{ pirmet.inspection_payment_reference|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">رابط دفع التفتيش</span>
          <span class="value">
            {% if pirmet.inspection_payment_link %}
              <a href="{{ pirmet.inspection_payment_link }}" target="_blank" rel="noopener">فتح الرابط</a>
            {% else %}
              -
            {% endif %}
          </span>
        </div>
        <div class="detail-item">
          <span class="label">البريد المرسل له رابط التفتيش</span>
          <span class="value">{{ pirmet.inspection_payment_email|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">البريد المرسل له رابط التصريح</span>
          <span class="value">{{ pirmet.payment_email|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">بريد تقديم الطلب</span>
          <span class="value">{{ pirmet.request_email|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">إيصال دفع التفتيش</span>
          <span class="value">
            {% if pirmet.inspection_payment_receipt %}
              <a href="{{ pirmet.inspection_payment_receipt.url }}" target="_blank" rel="noopener">فتح الإيصال</a>
            {% else %}
              -
            {% endif %}
          </span>
        </div>
        <div class="detail-item">
          <span class="label">إيصال دفع التصريح</span>
          <span class="value">
            {% if pirmet.payment_receipt %}
              <a href="{{ pirmet.payment_receipt.url }}" target="_blank" rel="noopener">فتح الإيصال</a>
            {% else %}
              -
            {% endif %}
          </span>
        </div>
      </div>
    </section>

    <section class="permit-section">
      <div class="section-title">بيانات الشركة</div>
      <div class="detail-grid">
        <div class="detail-item">
          <span class="label">اسم الشركة</span>
          <span class="value">{{ pirmet.company.name|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">رقم الرخصة التجارية</span>
          <span class="value">{{ pirmet.company.number|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">تاريخ انتهاء الرخصة التجارية</span>
          <span class="value">{{ pirmet.company.trade_license_exp|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">أنشطة الرخصة</span>
          <span class="value">{{ pirmet.company.business_activity_display|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">عنوان الموقع</span>
          <span class="value">{{ pirmet.company.address|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">رقم الهاتف الأرضي</span>
          <span class="value">{{ pirmet.company.landline|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">رقم هاتف المالك</span>
          <span class="value">{{ pirmet.company.owner_phone|default:"-" }}</span>
        </div>
        <div class="detail-item">
          <span class="label">البريد الإلكتروني</span>
          <span class="value">{{ pirmet.company.email|default:"-" }}</span>
        </div>
      </div>
    </section>

    {% if transport_details %}
      <section class="permit-section">
        <div class="section-title">بيانات النقل</div>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="label">رقم التواصل</span>
            <span class="value">{{ transport_details.contact_number|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">نوع النشاط</span>
            <span class="value">{{ transport_details.activity_type|default:"-" }}</span>
          </div>
        </div>
      </section>

      <section class="permit-section">
        <div class="section-title">تفاصيل المركبة</div>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="label">نوع المركبة</span>
            <span class="value">{{ transport_details.vehicle_type|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">لون المركبة</span>
            <span class="value">{{ transport_details.vehicle_color|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">رقم المركبة</span>
            <span class="value">{{ transport_details.vehicle_number|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">تاريخ انتهاء ملكية السيارة</span>
            <span class="value">{{ transport_details.vehicle_license_expiry|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">جهة الإصدار</span>
            <span class="value">{{ transport_details.issue_authority|default:"-" }}</span>
          </div>
        </div>
      </section>
    {% endif %}

    {% if waste_details %}
      <section class="permit-section">
        <div class="section-title">بيانات النفايات</div>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="label">تصنيف النفايات</span>
            <span class="value">{{ waste_details.waste_classification|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">كمية النفايات الشهرية</span>
            <span class="value">{{ waste_details.waste_quantity_monthly|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">أنواع النفايات</span>
            <span class="value">{{ waste_details.waste_types|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">حالة المادة</span>
            <span class="value">{{ waste_details.material_state|default:"-" }}</span>
          </div>
        </div>
      </section>

      <section class="permit-section">
        <div class="section-title">بيانات المشروع</div>
        <div class="detail-grid">
          <div class="detail-item">
            <span class="label">رقم المشروع</span>
            <span class="value">{{ waste_details.project_number|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">نوع المشروع</span>
            <span class="value">{{ waste_details.project_type|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">للمقاولات</span>
            <span class="value">{{ waste_details.contractors|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">الموظف المختص</span>
            <span class="value">{{ waste_details.employee_number|default:"-" }}</span>
          </div>
        </div>
      </section>
    {% endif %}

    {% if pirmet.permit_type == "pest_control" %}
      <section class="permit-section">
        <div class="section-title">بيانات المهندس</div>
        <div class="detail-grid">
          {% if pirmet.company.enginer %}
            <div class="detail-item">
              <span class="label">اسم المهندس</span>
              <span class="value">{{ pirmet.company.enginer.name }}</span>
            </div>
            <div class="detail-item">
              <span class="label">رقم الهاتف المتحرك</span>
              <span class="value">{{ pirmet.company.enginer.phone }}</span>
            </div>
            <div class="detail-item">
              <span class="label">البريد الإلكتروني</span>
              <span class="value">{{ pirmet.company.enginer.email }}</span>
            </div>
          {% else %}
            <div class="detail-item">
              <span class="label">بيانات المهندس</span>
              <span class="value">-</span>
            </div>
          {% endif %}
        </div>
      </section>
    {% endif %}

    {% if pirmet.permit_type == "pest_control" %}
      <section class="permit-section">
        <div class="section-title">بيانات الأنشطة</div>
        <div class="detail-grid">
          <div>
            <div class="hint" style="margin-bottom: 8px;">الأنشطة المصرح بها</div>
            <ul class="activity-list">
              {% if allowed_activities %}
                {% for item in allowed_activities %}
                  <li>
                    {% if item == "public_health_pest_control" %}
                      مكافحة آفات الصحة العامة
                    {% elif item == "flying_insects" %}
                      مكافحة الحشرات الطائرة
                    {% elif item == "rodents" %}
                      مكافحة القوارض
                    {% elif item == "termite_control" %}
                      مكافحة النمل الأبيض
                    {% elif item == "grain_pests" %}
                      مكافحة آفات الحبوب
                    {% else %}
                      {{ item }}
                    {% endif %}
                  </li>
                {% endfor %}
              {% else %}
                <li>لا توجد بيانات.</li>
              {% endif %}
              {% if pirmet.allowed_other %}
                <li>أخرى: {{ pirmet.allowed_other }}</li>
              {% endif %}
            </ul>
          </div>
          <div>
            <div class="hint" style="margin-bottom: 8px;">الأنشطة غير المصرح بها</div>
            <ul class="activity-list">
              {% if restricted_activities %}
                {% for item in restricted_activities %}
                  <li>
                    {% if item == "public_health_pest_control" %}
                      مكافحة آفات الصحة العامة
                    {% elif item == "flying_insects" %}
                      مكافحة الحشرات الطائرة
                    {% elif item == "rodents" %}
                      مكافحة القوارض
                    {% elif item == "termite_control" %}
                      مكافحة النمل الأبيض
                    {% elif item == "grain_pests" %}
                      مكافحة آفات الحبوب
                    {% else %}
                      {{ item }}
                    {% endif %}
                  </li>
                {% endfor %}
              {% else %}
                <li>لا توجد بيانات.</li>
              {% endif %}
              {% if pirmet.restricted_other %}
                <li>أخرى: {{ pirmet.restricted_other }}</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </section>

    {% endif %}

    <section class="permit-section documents">
      <div class="section-title">المستندات المرفقة</div>
      {% if pirmet.request_documents_bundle %}
        <ul class="activity-list">
          <li>
            <a href="{{ pirmet.request_documents_bundle.url }}">ملف المستندات الموحد</a>
          </li>
        </ul>
      {% endif %}
      {% if pirmet.documents.all %}
        <ul class="activity-list">
          {% for doc in pirmet.documents.all %}
            <li>
              <a href="{{ doc.file.url }}">{{ doc.file.name|cut:"pirmet_documents/" }}</a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if not pirmet.request_documents_bundle and not pirmet.documents.all %}
        <p class="hint">لا توجد مستندات مرفقة.</p>
      {% endif %}
    </section>

    {% if pirmet.status == "needs_completion" %}
      <section class="permit-section">
        <div class="section-title">استكمال النواقص</div>
        {% if pirmet.unapprovedReason %}
          <div class="alert">
            <strong>النواقص المطلوبة:</strong>
            <div style="margin-top: 6px;">{{ pirmet.unapprovedReason }}</div>
          </div>
        {% endif %}
        {% if can_complete_missing %}
          <form method="POST" enctype="multipart/form-data" class="review-form" style="margin-top: 12px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="complete_missing">
            <label for="missing_docs">إضافة مستندات</label>
            <input id="missing_docs" type="file" name="documents" multiple>
            <textarea name="completion_notes" placeholder="توضيح ما تم استكماله (اختياري)" rows="3"></textarea>
            <button type="submit">إرسال للاستكمال</button>
          </form>
        {% else %}
          <p class="hint">بانتظار استكمال النواقص من موظف الإدخال.</p>
        {% endif %}
      </section>
    {% endif %}

    <section class="permit-section">
      <div class="section-title">إجراءات المرحلة</div>
      {% if review_errors %}
        <div class="alert">
          <strong>يرجى تصحيح التالي:</strong>
          <ul style="margin: 8px 0 0 18px;">
            {% for error in review_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if can_update_pirmet %}
        <div class="detail-grid" style="margin-bottom: 12px;">
          <form method="POST" class="detail-item review-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_request_email">
            <label>بريد تقديم الطلب</label>
            <input type="email" name="request_email" value="{{ pirmet.request_email|default:'' }}" required>
            <button type="submit">تحديث بريد الطلب</button>
          </form>
        </div>
      {% endif %}

      {% if pirmet.status == "order_received" %}
        {% if can_record_payment %}
          <div class="detail-grid">
            <form method="POST" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="send_inspection_payment_link">
              <label>رابط دفع التفتيش</label>
              <input type="text" name="inspection_payment_link" value="{{ pirmet.inspection_payment_link|default:'' }}" required>
              <label>البريد المرسل له الرابط</label>
              <input type="email" name="inspection_payment_email" value="{{ pirmet.inspection_payment_email|default:pirmet.request_email }}" required>
              <label>رقم مرجع دفع التفتيش</label>
              <input type="text" name="inspection_payment_reference" value="{{ pirmet.inspection_payment_reference|default:'' }}" required>
              <button type="submit">إرسال رابط التفتيش</button>
            </form>
          </div>
        {% else %}
          <p class="hint">بانتظار إرسال رابط دفع التفتيش من الإدارة.</p>
        {% endif %}
      {% elif pirmet.status == "inspection_payment_pending" %}
        {% if can_record_payment %}
          <div class="detail-grid">
            <form method="POST" enctype="multipart/form-data" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="inspection_payment">
              <label>رقم مرجع دفع التفتيش</label>
              <input type="text" name="inspection_payment_reference" value="{{ pirmet.inspection_payment_reference|default:'' }}" required>
              <label>إيصال دفع التفتيش (PDF/صورة)</label>
              <input type="file" name="inspection_payment_receipt" accept=".pdf,image/*" required>
              <button type="submit">تأكيد دفع التفتيش</button>
            </form>
          </div>
        {% else %}
          <p class="hint">بانتظار دفع التفتيش.</p>
        {% endif %}
      {% elif pirmet.status == "approved" %}
        {% if can_record_payment %}
          <div class="detail-grid">
            <form method="POST" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="send_payment_link">
              <label>رابط دفع التصريح</label>
              <input type="text" name="payment_link" value="{{ pirmet.payment_link|default:'' }}" required>
              <label>البريد المرسل له الرابط</label>
              <input type="email" name="payment_email" value="{{ pirmet.payment_email|default:pirmet.request_email }}" required>
              <label>رقم مرجع دفع التصريح</label>
              <input type="text" name="payment_number" value="{{ pirmet.PaymentNumber|default:'' }}" required>
              <button type="submit">إرسال رابط التصريح</button>
            </form>
          </div>
        {% else %}
          <p class="hint">بانتظار إرسال رابط دفع التصريح من الإدارة.</p>
        {% endif %}
      {% elif pirmet.status == "payment_pending" %}
        {% if can_record_payment %}
          <div class="detail-grid">
            <form method="POST" enctype="multipart/form-data" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="payment">
              <label>رقم مرجع دفع التصريح</label>
              <input type="text" value="{{ pirmet.PaymentNumber|default:'-' }}" disabled>
              <label>إيصال دفع التصريح (PDF/صورة)</label>
              <input type="file" name="payment_receipt" accept=".pdf,image/*" required>
              <button type="submit">تأكيد دفع التصريح</button>
            </form>
          </div>
        {% else %}
          <p class="hint">بانتظار دفع التصريح.</p>
        {% endif %}
      {% elif pirmet.status == "payment_completed" %}
        {% if can_issue_pirmet %}
          <div class="detail-grid">
            <form method="POST" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="issue">
              <button type="submit">إصدار التصريح</button>
            </form>
          </div>
        {% else %}
          <p class="hint">جاهز للإصدار.</p>
        {% endif %}
      {% endif %}

      {% if pirmet.status == "payment_completed" or pirmet.status == "issued" %}
        {% if can_update_pirmet %}
          <div class="detail-grid" style="margin-top: 12px;">
            <form method="POST" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_permit_details">
              <label>تاريخ إصدار التصريح</label>
              <input type="date" name="issue_date" value="{{ pirmet.issue_date|date:'Y-m-d' }}">
              <label>تاريخ انتهاء التصريح</label>
              <input type="date" name="expiry_date" value="{{ pirmet.dateOfExpiry|date:'Y-m-d' }}">
              <button type="submit">تحديث البيانات</button>
            </form>
          </div>
        {% endif %}
      {% endif %}
    </section>

    <section class="permit-section">
      <div class="section-title">مراجعة المفتش</div>
      {% if pirmet.status == "review_pending" %}
        {% if can_review_pirmet %}
          <div class="detail-grid">
            <form method="POST" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="approve">
              <label for="inspector_id_approve">المفتش</label>
              <select id="inspector_id_approve" name="inspector_id" required>
                <option value="">اختيار</option>
                {% for engineer in engineers %}
                  <option value="{{ engineer.id }}">{{ engineer.name }}</option>
                {% endfor %}
              </select>
              <input type="text" name="remarks" placeholder="ملاحظات (اختياري)">
              <button type="submit">اعتماد الطلب</button>
            </form>
            <form method="POST" class="detail-item review-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="needs_completion">
              <label for="inspector_id_needs_completion">المفتش</label>
              <select id="inspector_id_needs_completion" name="inspector_id" required>
                <option value="">اختيار</option>
                {% for engineer in engineers %}
                  <option value="{{ engineer.id }}">{{ engineer.name }}</option>
                {% endfor %}
              </select>
              <textarea name="remarks" placeholder="النواقص المطلوبة" rows="2" required></textarea>
              <button class="danger" type="submit">طلب استكمال النواقص</button>
            </form>
          </div>
        {% else %}
          <p class="hint">بانتظار مراجعة المفتش.</p>
        {% endif %}
      {% endif %}

      {% if inspector_review %}
        <div class="detail-grid" style="margin-top: 12px;">
          <div class="detail-item">
            <span class="label">المفتش</span>
            <span class="value">{{ inspector_review.inspector.name|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">تاريخ المراجعة</span>
            <span class="value">{{ inspector_review.reviewDate|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">نتيجة المراجعة</span>
            <span class="value">{{ inspector_review.isApproved|yesno:"موافق,نواقص" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">ملاحظات</span>
            <span class="value">{{ inspector_review.comments|default:"-" }}</span>
          </div>
        </div>
      {% elif pirmet.status != "review_pending" %}
        <p class="hint">لا توجد مراجعة حتى الآن.</p>
      {% endif %}
    </section>

    <section class="permit-section">
      <div class="section-title">بيانات التفتيش والإتلاف</div>
      {% if disposal_process %}
        <div class="detail-grid" style="margin-bottom: 12px;">
          <div class="detail-item">
            <span class="label">رسوم التفتيش</span>
            <span class="value">{{ disposal_process.inspectionFee|default:"-" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">تم دفع الرسوم</span>
            <span class="value">{{ disposal_process.feePaid|yesno:"نعم,لا" }}</span>
          </div>
          <div class="detail-item">
            <span class="label">تاريخ دفع الرسوم</span>
            <span class="value">{{ disposal_process.feePaidDate|default:"-" }}</span>
          </div>
        </div>
        {% if inspection_report %}
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">مفتش التقرير</span>
              <span class="value">{{ inspection_report.inspector.name|default:"-" }}</span>
            </div>
            <div class="detail-item">
              <span class="label">تاريخ التفتيش</span>
              <span class="value">{{ inspection_report.inspectionDate|default:"-" }}</span>
            </div>
            <div class="detail-item">
              <span class="label">قرار التفتيش</span>
              <span class="value">
                {% if inspection_report.approval == "approved" %}
                  مقبول
                {% elif inspection_report.approval == "rejected" %}
                  مرفوض
                {% elif inspection_report.approval == "pending" %}
                  قيد الانتظار
                {% else %}
                  {{ inspection_report.approval|default:"-" }}
                {% endif %}
              </span>
            </div>
            <div class="detail-item">
              <span class="label">ملاحظات التقرير</span>
              <span class="value">{{ inspection_report.reportNotes|default:"-" }}</span>
            </div>
            <div class="detail-item">
              <span class="label">سبب الرفض</span>
              <span class="value">{{ inspection_report.rejectionReason|default:"-" }}</span>
            </div>
          </div>
        {% else %}
          <p class="hint">لا يوجد تقرير تفتيش بعد.</p>
        {% endif %}
      {% else %}
        <p class="hint">لا توجد بيانات تفتيش/إتلاف مرتبطة بهذا الطلب.</p>
      {% endif %}
    </section>

    <section class="permit-section">
      <div class="section-title">تتبع حالة الطلب والتغييرات</div>
      <div class="tracking-grid">
        <div class="tracking-panel">
          <div class="tracking-title">تتبع حالة الطلب</div>
          {% if status_changes %}
            <ul class="tracking-list">
              {% for change in status_changes %}
                <li class="tracking-item">
                  <div>
                    {% if change.change_type == "created" %}
                      تم إنشاء الطلب
                    {% elif change.change_type == "payment_update" %}
                      تحديث بيانات الدفع
                    {% elif change.change_type == "status_change" %}
                      {% if change.new_status == "order_received" %}
                        تم استلام الطلب
                      {% elif change.new_status == "inspection_payment_pending" %}
                        تم إرسال رابط دفع التفتيش وبانتظار الدفع
                      {% elif change.new_status == "review_pending" %}
                        بانتظار مراجعة المفتش
                      {% elif change.new_status == "needs_completion" or change.new_status == "rejected" %}
                        نواقص بحاجة للاستكمال
                      {% elif change.new_status == "approved" %}
                        تم الاعتماد من المفتش
                      {% elif change.new_status == "payment_pending" %}
                        بانتظار دفع التصريح
                      {% elif change.new_status == "payment_completed" %}
                        تم استلام الدفع
                      {% elif change.new_status == "issued" %}
                        تم إصدار التصريح
                      {% elif change.new_status == "inspection_pending" %}
                        تفتيش قيد الانتظار
                      {% elif change.new_status == "inspection_completed" %}
                        تم التفتيش
                      {% elif change.new_status == "disposal_approved" %}
                        تمت الموافقة على الإتلاف
                      {% elif change.new_status == "disposal_rejected" %}
                        تم رفض الإتلاف
                      {% else %}
                        {{ change.new_status|default:"-" }}
                      {% endif %}
                    {% else %}
                      {{ change.change_type }}
                    {% endif %}
                  </div>
                  <div class="tracking-meta">
                    بواسطة {{ change.changed_by.username|default:"-" }} • {{ change.created_at|date:"Y-m-d H:i" }}
                  </div>
                  {% if change.notes %}
                    <div class="tracking-meta">{{ change.notes }}</div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="hint">لا توجد تحديثات للحالة بعد.</p>
          {% endif %}
        </div>
        <div class="tracking-panel">
          <div class="tracking-title">تغييرات بيانات التصريح</div>
          {% if detail_changes %}
            <ul class="tracking-list">
              {% for change in detail_changes %}
                <li class="tracking-item">
                  <div>
                    {% if change.change_type == "document_upload" %}
                      رفع مستندات
                    {% elif change.change_type == "details_update" %}
                      تعديل بيانات التصريح
                    {% else %}
                      {{ change.change_type }}
                    {% endif %}
                  </div>
                  <div class="tracking-meta">
                    بواسطة {{ change.changed_by.username|default:"-" }} • {{ change.created_at|date:"Y-m-d H:i" }}
                  </div>
                  {% if change.notes %}
                    <div class="tracking-meta">{{ change.notes }}</div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="hint">لا توجد تغييرات مسجلة على البيانات.</p>
          {% endif %}
        </div>
      </div>
    </section>
  </div>
</section>
{% endblock %}
